-- dnsdist configuration for multi-client DNS routing
-- Routes DNS queries to different Pi-hole instances based on source IP

-- Listen on all interfaces, port 5353 (development)
setLocal("0.0.0.0:5353")

-- Logging
setVerbose(true)

-- Backend Pi-hole instances
-- Demo client: 203.0.113.10 -> pihole-demo:53
newServer({address="pihole-demo:53", name="pihole-demo", pool="demo"})

-- Default fallback (Google DNS)
newServer({address="8.8.8.8:53", name="google-dns", pool="default"})

-- Routing rules based on source IP
-- Demo client IP: 203.0.113.10 routes to pihole-demo
addAction(
    NetmaskGroupRule(newNMG({"203.0.113.10/32"})),
    PoolAction("demo")
)

-- All other IPs use default pool (Google DNS)
addAction(
    AllRule(),
    PoolAction("default")
)

-- Statistics and web interface
webserver("0.0.0.0:8053")
setWebserverConfig({password="novaguardian-dnsdist-2024", apiKey="novaguardian-api-key"})

-- Health checks
setServerPolicy(firstAvailable)

-- Cache settings
pc = newPacketCache(10000, {maxTTL=86400, minTTL=0})
getPool("demo"):setCache(pc)

print("dnsdist configured successfully!")
print("Listening on: 0.0.0.0:5353")
print("Web interface: http://0.0.0.0:8053")
print("Routing: 203.0.113.10/32 -> pihole-demo:53")
print("Default: All other IPs -> 8.8.8.8:53")
