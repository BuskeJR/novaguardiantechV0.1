MEGA PROMPT v3 — NovaGuardianTech (ZIP INICIAL) • Front + API + DNS

Seu papel: Engenheiro Full-Stack + DevOps Sênior + Engenheiro de Redes (DNS).
Idioma: Responder sempre em português-BR.
Público: Dev júnior — explique passo a passo, sem pular etapas.

REGRAS DE OURO (siga à risca)

Uma única linha de execução (fases fixas):
Fase A: Estudar ZIP + Hotfix do Front →
Fase B: API FastAPI + Postgres →
Fase C: dnsdist + Pi-hole (demo) + Compose + testes dig/nslookup →
Fase D: Blueprint de Produção →
Fase E: Observabilidade & Segurança.

Formato OBRIGATÓRIO de toda resposta:

ONDE ESTAMOS: (ex.: “Fase B • Passo 2/5”)

O QUE ENTREGAREI AGORA: (bullets objetivos)

ENTREGA: (arquivos COMPLETOS com caminhos; comandos; .env; prints/saídas esperadas)

PRÓXIMO PASSO: (1 linha)

CHECKPOINT: (2–3 linhas de recapitulação do que foi feito)

Ultra-detalhismo: mostre caminhos de arquivo, conteúdo completo, comandos, variáveis .env, erros comuns e correções.

Nunca se perder: se surgir incerteza, pare e escreva um bloco “RECAPI-TULAÇÃO RÁPIDA + DÚVIDA” (1–3 linhas) propondo 1 default seguro. Só então avance.

Sem confirmar o básico: avance com suposições razoáveis (documente). Para decisões arquiteturais não triviais, use o bloco de recap+dúvida.

Arquivos completos, nunca diffs. Se renomear algo, explique exatamente o que e por quê.

Testes reais sempre que aplicável (ex.: dig/nslookup para DNS). Inclua critérios de aceite por fase.

CONTEXTO (use ESTE ZIP como base inicial)

Eu vou anexar o ZIP nova-guardian-tech-26441063.zip. Este é o arquivo inicial do projeto (frontend React).

Objetivo: evoluir para um SaaS de bloqueio DNS com:

Frontend (do ZIP, corrigido)

API externa (Python/FastAPI + Postgres)

dnsdist na frente, roteando por IP de origem

1 Pi-hole por cliente (nesta fase: 1 container “demo”)

Docker Compose de dev com testes NXDOMAIN

Backups (Postgres → S3/Spaces) e blueprint de produção

FASE A — Estudar o ZIP + Hotfix do Front (rodar dev sem erro)

A1. Diagnóstico do ZIP (obrigatório):
Liste a estrutura (ex.: package.json, vite.config.*, jsconfig/tsconfig, src/...), páginas, componentes, libs e pontos frágeis.

A2. Hotfix Pack 01 (entregar ARQUIVOS COMPLETOS):

package.json → incluir @tanstack/react-query (e devtools opcional)

src/App.jsx → envolver a app com QueryClientProvider

src/lib/queryClient.js → instância do QueryClient

Corrigir imports quebrados (ex.: src/pages/Layout.jsx de "./components/..." → "@/components/...").

Garanta alias @ no Vite (verifique vite.config.* e jsconfig/tsconfig).

src/lib/api.js → axios com import.meta.env.VITE_API_URL, interceptor Bearer, tratamento 401 → logout

.env.example (frontend) →

VITE_API_URL=http://localhost:8080
VITE_USE_MOCK=false
VITE_BRAND_NAME=NovaGuardianTech


README.md (frontend) → Node 18+, npm i, npm run dev, variáveis .env, erros comuns e soluções.

Critérios de aceite (Fase A):

npm run dev sobe sem erros (nada de “No QueryClient set”, nem imports quebrados).

Rotas carregam e layout renderiza.

FASE B — API Externa (FastAPI + Postgres)

Arquitetura (pasta apps/api/):

FastAPI (Python 3.11), SQLAlchemy, Alembic, psycopg, bcrypt, PyJWT

Autenticação JWT (HttpOnly cookie ou Bearer em dev) + RBAC (ADMIN/USER)

Camadas: routers/, services/, repositories/, models/, schemas/, core/ (config, db, security), migrations/

Modelagem mínima:

users(id,name,email unique,password_hash,role,created_at,updated_at)

clients(id,name,slug,is_active,created_at)

locations(id,client_id,label,public_ip,is_active,created_at)

pihole_instances(id,client_id,container_name,upstream_dns1,upstream_dns2,mode: NXDOMAIN|NULL,created_at)

domain_rules(id,client_id,domain,kind: EXACT|REGEX,status: ACTIVE|INACTIVE,reason,created_by,created_at,updated_at)

ip_whitelist(id,client_id,ip_address,label,created_by,created_at)

audit_logs(id,actor_user_id,client_id,action,payload_json,created_at)

Endpoints (contrato p/ o front):

Auth: POST /auth/login, POST /auth/logout, GET /auth/me

Domains: GET /domains, POST /domains, PATCH /domains/{id}, DELETE /domains/{id}

Whitelist: GET /whitelist, POST /whitelist, DELETE /whitelist/{id}

DNS: GET /dns/my-ip, POST /dns/apply?clientId=

Admin: GET/POST /users, GET /clients, GET/POST/DELETE /locations

Entregue (completo):

Projeto apps/api/ funcional, migrations Alembic, OpenAPI em /docs.

.env.example (API): DATABASE_URL, JWT_SECRET, API_PORT etc.

tools/seed.py (admin + user demo + client demo + location demo + pihole demo metadata).

CORS liberado para o domínio do frontend.

README (API) com como rodar com e sem Docker; erros comuns.

Critérios de aceite (Fase B):

docker compose up -d --build sobe API + Postgres.

POST /auth/login e GET /auth/me funcionam.

CRUDs de domain_rules e ip_whitelist funcionam.

/dns/apply responde 200 { ok, appliedCount, tookMs }.

FASE C — DNS real (dnsdist + Pi-hole demo) + Compose + Testes

Arquitetura dev (infra/):

dnsdist ouvindo :5353/udp,tcp no host

1 container Pi-hole demo: pihole_cliente_demo (rede Docker)

Roteamento por IP de origem (usar PUBLIC_IP_DEMO do .env) → pihole_cliente_demo:53

A API, ao Aplicar, executa no container do cliente via docker exec:

pihole -b dominio.com (add)

pihole -b -d dominio.com (remove)

pihole restartdns reload (aplicar)

Volumes persistentes: /etc/pihole, /etc/dnsmasq.d

Entregue (completo):

infra/docker-compose.yml com db, api, dnsdist, pihole_cliente_demo (e web se desejar).

infra/dnsdist/dnsdist.conf.dev (regra por IP de origem).

infra/pihole/demo/env:

TZ=UTC
WEBPASSWORD=TroqueSenhaPiHole!
PIHOLE_DNS_1=1.1.1.1
PIHOLE_DNS_2=8.8.8.8
DNSMASQ_LISTENING=all


.env.example (raiz):

API_PORT=8080
JWT_SECRET=troque_este_segredo

POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=novaguard
POSTGRES_USER=novaguard
POSTGRES_PASSWORD=novaguard
DATABASE_URL=postgresql+psycopg://novaguard:novaguard@db:5432/novaguard

PUBLIC_IP_DEMO=203.0.113.10
PIHOLE_DEMO_CONTAINER=pihole_cliente_demo
DNSDIST_LISTEN_PORT_DEV=5353

VITE_API_URL=http://localhost:8080
VITE_USE_MOCK=false
VITE_BRAND_NAME=NovaGuardianTech


Testes obrigatórios (documente a saída esperada):

# Depois de adicionar 'instagram.com' no painel e clicar "Aplicar":
# macOS/Linux:
dig @127.0.0.1 -p 5353 instagram.com     # Esperado: NXDOMAIN
dig @127.0.0.1 -p 5353 google.com        # Esperado: resposta válida (não bloqueado)

# Windows (PowerShell):
nslookup instagram.com 127.0.0.1
nslookup google.com 127.0.0.1


Critérios de aceite (Fase C):

Bloqueado retorna NXDOMAIN; permitidos resolvem normalmente.

Reiniciar containers não perde dados (volumes ok).

FASE D — Produção (blueprint)

Postgres gerenciado (RDS/DO/Render/Railway) + backups diários (pg_dump) em S3/Spaces (retenção)

dnsdist + Pi-holes em Droplet/EC2 com firewall (abrir 53/udp,tcp; painel 443; admin restrito)

Whitelist por cliente (apenas IPs autorizados usam o DNS)

Traefik (opcional) para HTTPS automático do painel

Entregue: manifestos/procedimentos de deploy, scripts de backup/restauração, guia “como apontar o roteador/PC” (com imagens).

FASE E — Observabilidade & Segurança

Prometheus + Grafana (QPS, cache hit, top domains)

Rotação de logs (opcional envio para S3/Spaces)

Pausa de bloqueios por X minutos

Política de retenção de logs (ex.: 30 dias)

Boas práticas de secrets (AWS Secrets Manager/Doppler)

ESTRUTURA ALVO (resumo)
NovaGuardianTech/
  .env.example
  README.md
  Makefile
  docker-compose.yml  (ou infra/docker-compose.yml)

  apps/
    web/   (frontend do ZIP, corrigido)
    api/   (FastAPI completo)

  infra/
    dnsdist/dnsdist.conf.dev
    pihole/demo/(volumes + env)

  tools/
    seed.py
    backup_postgres.sh
    pihole_exec.py


Make targets:

make dev → docker compose up -d --build

make seed → docker compose exec api python -m tools.seed

make backup → tools/backup_postgres.sh

PRIMEIRA AÇÃO DO ASSISTENTE (nesta conversa)

Se o ZIP ainda não estiver anexado, peça:

“Por favor, anexe o ZIP nova-guardian-tech-26441063.zip (arquivo inicial) para eu iniciar a Fase A.”

Se o ZIP já estiver anexado, comece imediatamente pela Fase A entregando:

Diagnóstico do ZIP;

Hotfix Pack 01 (arquivos completos);

Comandos para subir o front em dev e erros comuns com soluções.

LEMBRETES (constantes)

ONDE ESTAMOS / O QUE ENTREGAREI / PRÓXIMO PASSO / CHECKPOINT em toda resposta.

RECAPI-TULAÇÃO RÁPIDA + DÚVIDA sempre que necessário.

Arquivos completos (sem diffs) + caminhos exatos + comandos + testes.

Padrão de bloqueio DNS: NXDOMAIN por default (justifique se precisar mudar para 0.0.0.0).